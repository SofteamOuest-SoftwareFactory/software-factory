- name: Copy traefik.tom
  copy: src=templates/traefik.toml dest=/tmp/traefik.toml

- name: Copy Traefik DaemonSet
  copy: src=templates/traefik-ds-ssl.yaml dest=/tmp/traefik-ds.yaml

#- command: openssl genrsa -des3 -passout pass:x -out /tmp/tls.pass.key 2048

#- command: openssl rsa -passin pass:x -in /tmp/tls.pass.key -out /tmp/tls.key

#- command: rm /tmp/tls.pass.key

#- command: openssl req -new -key /tmp/tls.key -out /tmp/tls.csr -subj "/C=FR/ST=-/L=-/O=wildwidewest/OU=-/CN=*.k8-dev.wildwidewest.xyz"

#- command: openssl x509 -req -days 365 -in /tmp/tls.csr -signkey /tmp/tls.key -out /tmp/tls.crt

- name: Copy CRT
  copy: src=files/tls.crt dest=/tmp/tls.crt

- name: Copy KEY
  copy: src=files/tls.key dest=/tmp/tls.key

- name: Configure RBAC
  command: kubectl apply -f https://raw.githubusercontent.com/containous/traefik/master/examples/k8s/traefik-rbac.yaml

- command: kubectl delete secret traefik-cert -n kube-system

- name: Create secret traefik-cert
  command: kubectl create secret generic traefik-cert --from-file=/tmp/tls.crt --from-file=/tmp/tls.key -n kube-system

- command: kubectl delete configmap traefik-conf -n kube-system

- name: Create configmap traefik-conf
  command: kubectl create configmap traefik-conf --from-file=/tmp/traefik.toml -n kube-system

- name: Deploy traefik
  command: kubectl apply -f /tmp/traefik-ds.yaml